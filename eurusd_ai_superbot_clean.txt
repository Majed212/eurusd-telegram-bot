import logging
import datetime
import requests
from telegram.ext import Updater, CommandHandler

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

TOKEN = '8162123139:AAEeIFt8Wz8TQYAgkCfhJUZGImlZM5-uCOM'

price_memory = []

def fetch_eurusd_price():
    try:
        response = requests.get('http://127.0.0.1:5005/eurusd', timeout=5)
        data = response.json()
        if 'price' not in data:
            raise ValueError("Ù„Ø§ ÙŠÙˆØ¬Ø¯ 'price' ÙÙŠ Ø§Ù„Ø±Ø¯")
        return round(data['price'], 5)
    except Exception as e:
        print("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±:", e)
        return None

def learn_and_predict():
    if len(price_memory) < 5:
        return "ğŸ“Š Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù… ÙŠØªØ¹Ù„Ù… Ø¨Ù…Ø§ ÙÙŠÙ‡ Ø§Ù„ÙƒÙØ§ÙŠØ© Ø¨Ø¹Ø¯ Ù„ØªØ­Ù„ÙŠÙ„ EUR/USD."
    avg = sum(price_memory[-5:-1]) / 4
    trend = "ğŸ”¼ ØµØ¹ÙˆØ¯ Ù…ØªÙˆÙ‚Ø¹" if price_memory[-1] > avg else "ğŸ”» Ù‡Ø¨ÙˆØ· Ù…ØªÙˆÙ‚Ø¹"
    return trend

def start(update, context):
    update.message.reply_text("ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª ØªØ­Ù„ÙŠÙ„ EUR/USD.\nØ§ÙƒØªØ¨ /analyze Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø­Ø¸ÙŠ.")

def analyze(update, context):
    now = datetime.datetime.now().strftime("%H:%M:%S")
    price = fetch_eurusd_price()
    if price:
        price_memory.append(price)
        if len(price_memory) > 100:
            price_memory.pop(0)
        trend = learn_and_predict()
        update.message.reply_text(
            f"ğŸ•’ Ø§Ù„ØªÙˆÙ‚ÙŠØª: {now}\nğŸ’¶ EUR/USD: {price}\nğŸ¤– Ø§Ù„ØªÙˆÙ‚Ø¹: {trend}"
        )
    else:
        update.message.reply_text("âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù„Ø­Ø¸ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹.")

updater = Updater(token=TOKEN, use_context=True)
dp = updater.dispatcher
dp.add_handler(CommandHandler("start", start))
dp.add_handler(CommandHandler("analyze", analyze))
updater.start_polling()
updater.idle()
